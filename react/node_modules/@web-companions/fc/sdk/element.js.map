{"version":3,"file":"element.js","sourceRoot":"","sources":["../../src/sdk/element.ts"],"names":[],"mappings":"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","sourcesContent":["import { AF } from '../hooks';\n\nimport type {\n  ComponentFunc,\n  ElementProperties,\n  AdapterFunc,\n  Optional,\n  ElementMapper,\n  ElementRender,\n  ElementIniConfig,\n  ElementComponent,\n  ElementComponentProps,\n} from '../common.model';\nimport { defMapper } from '../utils';\n\n/**\n * Initialize Element Generator\n */\nexport function EG<P, PP extends ElementProperties<P> = ElementProperties<P>, RT = any>(config: ElementIniConfig<P, PP, RT>) {\n  const mapper = config.mapper || defMapper;\n\n  type OP = Optional<P, { [k in keyof PP]: PP[k] extends { default: any } ? k : never }[keyof P]>;\n\n  return (func: ComponentFunc<P>) => {\n    const element = build(func, config.props || {}, config.render, mapper, config.shadow);\n\n    return (\n      name: string,\n      options?: ElementDefinitionOptions\n    ): ElementComponent<typeof element, OP> => {\n      try {\n        customElements.define(name, element, options);\n      } catch (e) {\n        console.warn(e);\n      }\n\n      const component = async (_p: ElementComponentProps<OP>) => {\n        return customElements.whenDefined(name).then(() => customElements.get(name));\n      };\n\n      component.element = element;\n      component.adapter = <T>(func: AdapterFunc<OP, T>, defaultProps?: OP) => func(name, defaultProps);\n\n      return component;\n    };\n  };\n}\n\n/**\n *  Build a new custom element class\n * @param func\n * @param props\n * @param render\n * @param mapper\n * @param shadow\n */\nfunction build<P, RT>(\n  func: ComponentFunc<P>,\n  props: ElementProperties<any>,\n  render: ElementRender<RT>,\n  mapper: ElementMapper<P>,\n  shadow?: ShadowRootInit | undefined\n) {\n  const customEl = class extends HTMLElement {\n    // TODO: change to Symbol\n    static attributes: { [x: string]: string } = {};\n    static get observedAttributes() {\n      return Object.values(this.attributes);\n    }\n\n    _props: Partial<P> = {};\n    public set props(newProps) {\n      if (newProps !== undefined && this.props !== newProps) {\n        this._props = newProps;\n        this.render();\n      }\n    }\n    public get props() {\n      return this._props as P;\n    }\n\n    aFunc: ComponentFunc<P>;\n\n    constructor() {\n      super();\n\n      const ctr = shadow !== undefined ? this.attachShadow(shadow) : this;\n\n      this.aFunc = AF(func, (r: any) => render(r, ctr));\n\n      for (const pK in props) {\n        const pV = props[pK];\n        let attr: string | undefined = undefined;\n\n        if ('type' in pV) {\n          this.props[pK] = pV.default;\n          attr = pV.attribute;\n        }\n\n        Reflect.defineProperty(this, pK, {\n          get: () => {\n            return this.props[pK];\n          },\n          set: (value: keyof P) => {\n            this.props = mapper.apply(this, [this.props, pK as keyof P, value, attr]);\n          },\n          enumerable: true,\n        });\n      }\n    }\n\n    /**\n     * LIFECYCLE\n     * Invoked when the custom element is first connected to the document's DOM.\n     */\n    connectedCallback(): void {\n      this.render();\n    }\n\n    /**\n     * LIFECYCLE\n     * Invoked when one of the custom element's attributes is added, removed, or changed.\n     */\n    attributeChangedCallback(name: string, oldValue: string, newValue: string) {\n      if (oldValue !== newValue) {\n        for (const [attrKey, attrName] of Object.entries(this.constructor['attributes'])) {\n          if (attrName === name && this[attrKey] !== newValue) {\n            this[attrKey] = newValue;\n            break;\n          }\n        }\n      }\n    }\n\n    /**\n     * Render function\n     */\n    render() {\n      this.isConnected && Reflect.apply(this.aFunc, this, [this.props]);\n    }\n  };\n\n  // TODO: change to Symbol\n  const attrKey = 'attributes';\n  const attributes = Reflect.get(customEl, attrKey);\n\n  for (const pK in props) {\n    const pV = props[pK];\n    if ('type' in pV && pV.attribute !== undefined) {\n      Reflect.defineProperty(customEl, attrKey, {\n        value: {\n          ...attributes,\n          [pK]: pV.attribute,\n        },\n        enumerable: true,\n        writable: true,\n      });\n    }\n  }\n\n  return customEl;\n}\n"]}